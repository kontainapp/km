name: Configure KRUN
description: Configure static krun from artifact
inputs:
  target-dir:
    description: directory to configure krun in ( build/opt/kontain or /opt/kontain/)
    required: true

runs:
  using: "composite"
  steps:
    # get static krun created by krun-static-build job
    - name: Download krun-static atrifact
      uses: actions/download-artifact@v2
      with:
        name: krun-static
        path: build/container-runtime

    - name: Configure KRUN
      run: |
        sudo mkdir -p ${{inputs.target-dir}}/bin
        # rename krun.static to krun
        sudo mv build/container-runtime/krun.static ${{inputs.target-dir}}/bin/krun
        # make krun-label-trigger
        sudo ln ${{inputs.target-dir}}/bin/krun ${{inputs.target-dir}}/bin/krun-label-trigger
        sudo cp container-runtime/docker_config.sh ${{inputs.target-dir}}/bin/docker_config.sh
        [[ ${{inputs.target-dir}} == /opt/* ]] && sudo mv build/opt/kontain/bin/km /opt/kontain/bin/km
        sudo chmod +x ${{inputs.target-dir}}/bin/km ${{inputs.target-dir}}/bin/krun
        sudo bash ./container-runtime/podman_config.sh
        sudo bash ./container-runtime/docker_config.sh
      shell: bash
