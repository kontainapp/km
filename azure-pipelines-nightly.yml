name: ci-nightly-$(BuildID) $(Date:yyyyMMdd)$(Rev:.r)

# Must explicitly opt out of pr and CI trigger.
pr: none
trigger: none

schedules:
  - cron: "0 7 * * *"
    displayName: Daily build midnight pacific time (UTC + 7)
    branches:
      include:
        - master

jobs:
  - job: nightly_ci
    variables:
      VM_IMAGE: "ubuntu-18.04"
      CLUSTER_NAME: "aks-kontain-ci-nightly-$(Build.BuildId)"
      VM_SIZE: "Standard_D4_v3" # choose a vm size to avoid the vcpu quota on azure
      buildenv_image_version: alpine_libs # use this for all buildenv containers
      # BUILDENV_IMAGE_VERSION: latest # use this for all buildenv containers. TODO - rollback to latest when we all rebase
      IMAGE_VERSION: ci-nightly-$(Build.BuildId) # use this for all other containers
      K8S_TEST_ERR_NO_CLEANUP: true # OK to not clean up after error for nightly
      # trace: true # uncomment to enable '-x' in all bash scripts

    # Default job has a 60 minutes timeout. Sets this to 0 to use the max
    # 360 minutes timeout.
    timeoutInMinutes: 0
    pool:
      vmImage: $(VM_IMAGE)
    steps:
      - template: templates/setup.yaml

      - template: templates/build.yaml

      - bash: cloud/azure/aks_ci_create.sh $(CLUSTER_NAME) $(SP_appId) $(SP_password)
        displayName: Create k8s Cluster

      - bash: make -C cloud/k8s/kontaind install
        displayName: deploy and verify kontaind

      - template: templates/ci_nightly.yaml

      - bash: cloud/azure/aks_ci_destroy.sh $(CLUSTER_NAME)
        displayName: Tear down k8s Cluster

      - bash: |
          [ "$TRACE" ] && set -x
          make -C cloud/azure ci-image-purge CI_IMAGE_DRY_RUN=""
          rm -f ~/.kube/config
          az logout
        condition: always()
        displayName: Cleanup and logout
