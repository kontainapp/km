# This file contains all the tests that are designed to run for every PR. Tests
# here should be short. Longer tests should be moved to ci_nighly pipeline.

steps:
  - bash: make -C tests test-withk8s
    displayName: KM tests - run on Kubernetes
    timeoutInMinutes: 15

  - bash: make -C payloads/python test-withk8s
    displayName: Python.km tests - run on Kubernetes
    timeoutInMinutes: 5

  - bash: make -C payloads/node test-withk8s
    displayName: Node.km tests - run on Kubernetes
    timeoutInMinutes: 5

  - bash: |
      sudo apt-get install libcap-dev libseccomp-dev libyajl-dev
      make -C container-runtime clobber
      make -C container-runtime all
      export XDG_RUNTIME_DIR=/tmp/run/user/appuser
      mkdir -p ${XDG_RUNTIME_DIR}
      make -C container-runtime test
      grep "^FAIL:" container-runtime/crun/test-suite.log | sed -e "s/^FAIL: //" | grep -v "\.py" | sort -u | \
        while read testname; do \
          echo "============= container-runtime/crun/$testname.log ================"; cat container-runtime/crun/$testname.log; \
          echo "============= container-runtime/crun/$testname.trs ================"; cat container-runtime/crun/$testname.trs; \
        done
    displayName: crun tests - run on the vm
    timeoutInMinutes: 5
