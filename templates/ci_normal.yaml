# This file contains all the tests that are designed to run for every PR. Tests
# here should be short. Longer tests should be moved to ci_nighly pipeline.

steps:
  - bash: make -C tests test-withk8s
    displayName: KM tests - run on Kubernetes
    timeoutInMinutes: 15

  - bash: make -C payloads/python test-withk8s
    displayName: Python.km tests - run on Kubernetes
    timeoutInMinutes: 5

  - bash: make -C payloads/node test-withk8s
    displayName: Node.km tests - run on Kubernetes
    timeoutInMinutes: 5

  - bash: |
      apt-get install libseccomp libcap yajl
      # Fixup Makefile that contains container absolute paths
      sed -e "s|\(/.*\)\(/container-runtime\)|`pwd`\2|" <container-runtime/crun/Makefile >container-runtime/crun/Makefile.hacked
      mv container-runtime/crun/Makefile.hacked container-runtime/crun/Makefile
      make -C container-runtime test
    displayName: crun tests
