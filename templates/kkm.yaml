# Contains steps to build kkm
steps:
  - bash: make -C kkm/kkm
    displayName: build kkm

  - bash: sudo insmod kkm/kkm/kkm.ko
    displayName: install kkm

  - bash: make -C kkm/test_kkm
    displayName: build test kkm

  - bash: ./kkm/test_kkm/test_kkm
    displayName: test kkm

  - bash: |
      set -e ; [ "$TRACE" ] && set -x
      make -C tests pull-buildenv-image .buildenv-local-lib
      make -j withdocker
      make -C km -j withdocker TARGET=coverage
      make -C tests testenv-image
    displayName: KM build - set build environment, build, create test container

  - bash: make -C tests test-withdocker HYPERVISOR_DEVICE=/dev/kkm DOCKER_INTERACTIVE=
    displayName: Test with kkm
    timeoutInMinutes: 15

  - bash: cloud/aws/kkm-regression.bash $(System.PullRequest.SourceBranch)
    displayName: Test with kkm on aws
    timeoutInMinutes: 20
    env:
      KONTAIN_AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      KONTAIN_AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      KONTAIN_AWS_FEDORA_PASSWD: $(AWS_FEDORA_PASSWD)
