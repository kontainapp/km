#
# Template for running BATS tests in  Kubernetes.
# We use m4 to replace needed macro. 'Macro' is everything with '()' below.
#
# Ideally , we need to use Helm3 for templates; for now it's MUCH easier just to use m4.
# However, if this one gets more compex, we will switch
#
# We use it mainly from tests/Makefile. Example:
# m4 -DUSER=msterin- -DDTYPE=fedora -DIMAGE_VERSION=CI-778 \
#    -DREGISTRY=kontainkubecr.azurecr.io -DSUFFIX=ci-778 \
#    -DCOMMAND='"sleep", "3600"' \
#     bats-pod.yaml | kubectl apply -f -
#

apiVersion: v1
kind: Pod
metadata:
  name: USER()test-km-DTYPE()-SUFFIX()
spec:
  containers:
    - name: USER()test-km-DTYPE()-SUFFIX()
      image: REGISTRY()/test-km-DTYPE():IMAGE_VERSION()
      imagePullPolicy: IfNotPresent
      securityContext:
        privileged: false
        allowPrivilegeEscalation: false
      resources:
        requests:
          devices.kubevirt.io/kvm: "1"
          cpu: "250m"
        limits:
          devices.kubevirt.io/kvm: "1"
          cpu: "1"
      command: [COMMAND()]
  restartPolicy: Never
